<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DUMODZ | Enterprise Admin Panel</title>
    
    <!-- CSS Dependencies -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <style>
        :root {
            --primary: #6366f1;
            --secondary: #64748b;
            --dark-bg: #0b0f19;
            --card-bg: #ffffff;
            --success: #22c55e;
            --danger: #ef4444;
            --warning: #f59e0b;
            --info: #06b6d4;
            --sidebar-w: 260px;
        }

        body {
            font-family: 'Outfit', sans-serif;
            background-color: #f8fafc;
            color: #1e293b;
            margin: 0;
            overflow-x: hidden;
        }

        /* üîê Login Screen - Premium Design */
        #login-gate {
            position: fixed; inset: 0; background: radial-gradient(circle at top right, #1e1b4b, #0f172a);
            z-index: 9999; display: flex; align-items: center; justify-content: center; padding: 15px;
        }
        .login-card {
            background: rgba(255, 255, 255, 0.98); backdrop-filter: blur(20px);
            padding: 35px; border-radius: 28px; width: 100%; max-width: 400px;
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5);
        }

        /* üì± Sidebar & Layout */
        .sidebar {
            width: var(--sidebar-w); background: var(--dark-bg); height: 100vh; position: fixed;
            color: white; padding: 20px; transition: 0.3s; z-index: 1050; left: 0;
        }
        .sidebar-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.5); 
            display: none; z-index: 1040; backdrop-filter: blur(4px);
        }
        .main-wrapper { margin-left: var(--sidebar-w); padding: 25px; transition: 0.3s; }

        @media (max-width: 991px) {
            .sidebar { left: calc(-1 * var(--sidebar-w)); }
            .sidebar.active { left: 0; }
            .main-wrapper { margin-left: 0; padding: 15px; }
            .sidebar-overlay.active { display: block; }
        }

        /* üé¥ Key Card Design - Advanced */
        .key-card {
            background: white; border-radius: 20px; border: 1px solid #e2e8f0;
            padding: 20px; transition: all 0.3s ease; height: 100%;
            display: flex; flex-direction: column; justify-content: space-between;
        }
        .key-card:hover { transform: translateY(-5px); box-shadow: 0 15px 30px -5px rgba(0,0,0,0.1); border-color: var(--primary); }
        
        .status-badge {
            font-size: 10px; font-weight: 700; padding: 5px 12px; border-radius: 30px;
            text-transform: uppercase; letter-spacing: 0.5px;
        }
        .bg-active { background: #dcfce7; color: #166534; }
        .bg-lifetime { background: #ede9fe; color: #5b21b6; }
        .bg-expired { background: #fee2e2; color: #991b1b; }
        .bg-blocked { background: #f1f5f9; color: #475569; }

        /* üîò Buttons & Inputs */
        .btn-modern {
            background: var(--primary); color: white; border-radius: 12px;
            padding: 10px 20px; font-weight: 600; border: none; transition: 0.3s;
        }
        .btn-modern:hover { background: #4338ca; box-shadow: 0 10px 15px -3px rgba(99, 102, 241, 0.4); }
        
        .nav-link {
            color: #94a3b8; padding: 12px 15px; border-radius: 12px; margin-bottom: 8px;
            display: flex; align-items: center; text-decoration: none; transition: 0.2s;
        }
        .nav-link.active, .nav-link:hover { background: #1e293b; color: white; }

        .stat-card {
            padding: 20px; border-radius: 20px; border: none; 
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); text-align: center;
        }

        /* Mobile Adjustments (768px) */
        @media (max-width: 768px) {
            .stat-card h2 { font-size: 1.5rem; }
            .key-card h5 { font-size: 1.1rem; }
            .modal-dialog { margin: 10px; }
        }
    </style>
</head>
<body>

<div class="sidebar-overlay" id="overlay" onclick="toggleSidebar()"></div>

<!-- üîê Login Gate -->
<div id="login-gate">
    <div class="login-card text-center">
        <img src="https://raw.githubusercontent.com/DarkUnkwonModZ/Blogger-DarkUnkownModZ-Appinfo/refs/heads/main/IMG/circle-logo-dumodz.png" width="70" class="mb-3 rounded-circle border border-3 border-primary shadow">
        <h4 class="fw-bold">Admin Portal</h4>
        <p class="text-muted small mb-4">DUMODZ Cloud Security Management</p>
        
        <div class="text-start">
            <div class="mb-3">
                <label class="small fw-bold text-secondary mb-1">Login Email</label>
                <input type="text" id="log-email" class="form-control bg-light py-2 border-0" value="du.darkunkwon.info@gmail.com" readonly>
            </div>
            <div class="mb-4">
                <label class="small fw-bold text-secondary mb-1">Access Password</label>
                <input type="password" id="log-pass" class="form-control py-2" placeholder="Enter Password">
            </div>
            <button class="btn btn-modern w-100 py-2 fw-bold" onclick="handleLogin()">
                <i class="fas fa-shield-alt me-2"></i> Verify Identity
            </button>
        </div>
    </div>
</div>

<!-- üìÅ Sidebar -->
<aside class="sidebar" id="sidebar">
    <div class="d-flex align-items-center mb-5 px-2">
        <img src="https://raw.githubusercontent.com/DarkUnkwonModZ/Blogger-DarkUnkownModZ-Appinfo/refs/heads/main/IMG/circle-logo-dumodz.png" width="35" class="me-2">
        <div>
            <h5 class="fw-bold mb-0">DUMODZ <span class="text-primary">PRO</span></h5>
            <small class="text-secondary" style="font-size: 10px;">Version 5.0 Enterprise</small>
        </div>
    </div>
    
    <nav>
        <a href="#" class="nav-link active"><i class="fas fa-th-large me-3"></i> Dashboard</a>
        <a href="#appConfig" class="nav-link"><i class="fas fa-sliders-h me-3"></i> App Config</a>
        <a href="#keyManager" class="nav-link"><i class="fas fa-key me-3"></i> Key Database</a>
    </nav>

    <div style="position: absolute; bottom: 20px; width: calc(100% - 40px);">
        <button class="btn btn-danger w-100 rounded-3 py-2 fw-bold" onclick="handleLogout()">
            <i class="fas fa-power-off me-2"></i> Sign Out
        </button>
    </div>
</aside>

<!-- üöÄ Main Content -->
<main class="main-wrapper">
    <header class="d-flex justify-content-between align-items-center mb-4">
        <div class="d-flex align-items-center">
            <button class="btn btn-white shadow-sm d-lg-none me-3" onclick="toggleSidebar()"><i class="fas fa-bars"></i></button>
            <h4 class="fw-bold mb-0">Overview</h4>
        </div>
        <button class="btn btn-modern shadow-sm" onclick="openAddModal()">
            <i class="fas fa-plus-circle me-1"></i> <span class="d-none d-sm-inline">New License</span>
        </button>
    </header>

    <!-- üìä Real-time Stats -->
    <div class="row g-3 mb-5">
        <div class="col-6 col-lg-3">
            <div class="stat-card bg-white">
                <p class="text-muted small fw-bold mb-1">TOTAL KEYS</p>
                <h2 class="fw-bold mb-0" id="stat-total">0</h2>
            </div>
        </div>
        <div class="col-6 col-lg-3">
            <div class="stat-card bg-white border-start border-4 border-success">
                <p class="text-success small fw-bold mb-1">ACTIVE</p>
                <h2 class="fw-bold mb-0" id="stat-active">0</h2>
            </div>
        </div>
        <div class="col-6 col-lg-3">
            <div class="stat-card bg-white border-start border-4 border-danger">
                <p class="text-danger small fw-bold mb-1">EXPIRED</p>
                <h2 class="fw-bold mb-0" id="stat-expired">0</h2>
            </div>
        </div>
        <div class="col-6 col-lg-3">
            <div class="stat-card bg-white border-start border-4 border-primary">
                <p class="text-primary small fw-bold mb-1">LIFETIME</p>
                <h2 class="fw-bold mb-0" id="stat-lifetime">0</h2>
            </div>
        </div>
    </div>

    <!-- ‚öôÔ∏è App Settings -->
    <section id="appConfig" class="key-card border-0 shadow-sm p-4 mb-5">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h5 class="fw-bold mb-0"><i class="fas fa-tools me-2 text-primary"></i> Global App Configuration</h5>
            <button class="btn btn-dark btn-sm px-3 rounded-pill" onclick="saveAppConfig()">Update Changes</button>
        </div>
        <div class="row g-3">
            <div class="col-md-6">
                <label class="small fw-bold text-secondary mb-1">Dashboard Title</label>
                <input type="text" id="cfg-title" class="form-control mb-3 py-2">
                <label class="small fw-bold text-secondary mb-1">Login Instructions</label>
                <textarea id="cfg-ins" class="form-control py-2" rows="4"></textarea>
            </div>
            <div class="col-md-6">
                <label class="small fw-bold text-secondary mb-1">Application Logo URL</label>
                <input type="text" id="cfg-logo" class="form-control mb-3 py-2">
                <label class="small fw-bold text-secondary mb-1">Telegram Support Link</label>
                <input type="text" id="cfg-buy" class="form-control mb-3 py-2">
                <div class="form-check form-switch mt-3">
                    <input class="form-check-input" type="checkbox" id="cfg-dialog">
                    <label class="form-check-label ms-2 fw-bold">Active Login Dialog Popup</label>
                </div>
            </div>
        </div>
    </section>

    <!-- üîë Key Database -->
    <section id="keyManager">
        <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-3 mb-4">
            <h5 class="fw-bold mb-0">Key Database (<span id="key-count">0</span>)</h5>
            <div class="search-box position-relative" style="max-width: 350px; width: 100%;">
                <i class="fas fa-search position-absolute text-muted" style="top: 13px; left: 15px;"></i>
                <input type="text" id="search-input" class="form-control ps-5 py-2 rounded-pill shadow-sm" placeholder="Search key or device ID..." onkeyup="filterKeys()">
            </div>
        </div>
        <div class="row g-4" id="keys-container">
            <!-- Dynamic Key Cards -->
        </div>
    </section>
</main>

<!-- üõ† License Manager Modal -->
<div class="modal fade" id="keyModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 rounded-4">
            <div class="modal-header border-0 pb-0 px-4 pt-4">
                <h5 class="fw-bold" id="modalTitle">License Editor</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body px-4">
                <input type="hidden" id="edit-id">
                <div class="mb-3">
                    <label class="small fw-bold mb-1">License Key</label>
                    <div class="input-group">
                        <input type="text" id="key-name" class="form-control fw-bold py-2" placeholder="DUMODZ-XXXX">
                        <button class="btn btn-primary" onclick="generateKey()"><i class="fas fa-magic"></i></button>
                    </div>
                </div>
                <div class="mb-3">
                    <label class="small fw-bold mb-1">Expiration (Text/Unlimited/Date)</label>
                    <div class="input-group">
                        <input type="text" id="key-expiry" class="form-control py-2" placeholder="YYYY-MM-DD or Unlimited">
                        <input type="date" class="form-control p-0 border-0" style="max-width: 45px;" onchange="document.getElementById('key-expiry').value = this.value">
                    </div>
                </div>
                <div class="row g-2">
                    <div class="col-6">
                        <label class="small fw-bold mb-1">Status</label>
                        <select id="key-status" class="form-select py-2">
                            <option value="active">Active</option>
                            <option value="lifetime">Lifetime</option>
                            <option value="expired">Expired</option>
                            <option value="blocked">Blocked</option>
                        </select>
                    </div>
                    <div class="col-6">
                        <label class="small fw-bold mb-1">Device ID Lock</label>
                        <input type="text" id="key-device" class="form-control py-2" placeholder="ANY">
                    </div>
                </div>
            </div>
            <div class="modal-footer border-0 p-4">
                <button class="btn btn-modern w-100 py-2" onclick="saveKeyData()">Save Key Information</button>
            </div>
        </div>
    </div>
</div>

<!-- Firebase Logic -->
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getDatabase, ref, onValue, set, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAqJ-pO0CvynjCCaskOkG6Jiht5a9aVwws",
        authDomain: "key-login-dialog.firebaseapp.com",
        databaseURL: "https://key-login-dialog-default-rtdb.firebaseio.com",
        projectId: "key-login-dialog",
        storageBucket: "key-login-dialog.firebasestorage.app",
        messagingSenderId: "710432558346",
        appId: "1:710432558346:web:e4bc5310b70c652567bef3",
        measurementId: "G-ZZEHBTGKKH"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);
    const rootRef = ref(db, 'key-login-dumodz');
    let masterData = null;
    const keyModal = new bootstrap.Modal(document.getElementById('keyModal'));

    // --- üîê AUTH SYSTEM ---
    window.handleLogin = async () => {
        const email = "du.darkunkwon.info@gmail.com";
        const pass = document.getElementById('log-pass').value;
        if(!pass) return Swal.fire('Error', 'Password Required!', 'error');

        try {
            await setPersistence(auth, browserLocalPersistence);
            await signInWithEmailAndPassword(auth, email, pass);
            Swal.fire({ title: 'Welcome Back!', icon: 'success', timer: 1500, showConfirmButton: false });
        } catch (e) {
            Swal.fire('Auth Failed', 'Invalid administrator password.', 'error');
        }
    };

    window.handleLogout = () => {
        Swal.fire({
            title: 'Logout?', text: 'Your session will be cleared.', 
            icon: 'warning', showCancelButton: true
        }).then(r => r.isConfirmed && signOut(auth));
    };

    onAuthStateChanged(auth, (user) => {
        document.getElementById('login-gate').style.display = user ? 'none' : 'flex';
        if(user) fetchData();
    });

    // --- üìä DATA HANDLING ---
    function fetchData() {
        onValue(rootRef, (snap) => {
            masterData = snap.val();
            if(masterData) renderUI();
        });
    }

    function renderUI() {
        const dbList = masterData.auth_database || [];
        
        // Stats Calc
        document.getElementById('stat-total').innerText = dbList.length;
        document.getElementById('stat-active').innerText = dbList.filter(x => x.status === 'active').length;
        document.getElementById('stat-expired').innerText = dbList.filter(x => x.status === 'expired').length;
        document.getElementById('stat-lifetime').innerText = dbList.filter(x => x.status === 'lifetime').length;
        document.getElementById('key-count').innerText = dbList.length;

        // Config Inputs
        document.getElementById('cfg-title').value = masterData.app_config.title;
        document.getElementById('cfg-logo').value = masterData.app_config.logo_url;
        document.getElementById('cfg-buy').value = masterData.app_config.buy_url;
        document.getElementById('cfg-ins').value = masterData.app_config.instruction;
        document.getElementById('cfg-dialog').checked = masterData.app_config.dialog_on;

        // Cards Grid
        const container = document.getElementById('keys-container');
        container.innerHTML = '';
        dbList.forEach((item, index) => {
            container.innerHTML += `
                <div class="col-12 col-md-6 col-lg-4 search-item" data-search="${item.key.toLowerCase()} ${item.device_id.toLowerCase()}">
                    <div class="key-card">
                        <div>
                            <div class="d-flex justify-content-between align-items-start mb-3">
                                <span class="status-badge bg-${item.status}">${item.status}</span>
                                <div class="dropdown">
                                    <i class="fas fa-ellipsis-v text-muted px-2" role="button" data-bs-toggle="dropdown"></i>
                                    <ul class="dropdown-menu dropdown-menu-end shadow border-0 rounded-3">
                                        <li><a class="dropdown-item py-2" href="javascript:void(0)" onclick="openEditModal(${index})"><i class="fas fa-pen me-2 text-primary"></i> Edit</a></li>
                                        <li><a class="dropdown-item py-2 text-danger" href="javascript:void(0)" onclick="deleteKey(${index})"><i class="fas fa-trash-alt me-2"></i> Delete</a></li>
                                    </ul>
                                </div>
                            </div>
                            <h5 class="fw-bold text-dark mb-1">${item.key}</h5>
                            <p class="small text-muted mb-1"><i class="fas fa-mobile-alt me-2"></i>Device: ${item.device_id || 'ANY'}</p>
                            <p class="small text-muted mb-3"><i class="fas fa-clock me-2"></i>Expiry: ${item.expiry}</p>
                        </div>
                        <button class="btn btn-light btn-sm w-100 fw-bold border" onclick="copyKey('${item.key}')">
                            <i class="fas fa-copy me-1"></i> Copy Access Key
                        </button>
                    </div>
                </div>
            `;
        });
    }

    // --- üõ† CRUD ACTIONS ---
    window.saveAppConfig = () => {
        const payload = {
            buy_url: document.getElementById('cfg-buy').value,
            dialog_on: document.getElementById('cfg-dialog').checked,
            instruction: document.getElementById('cfg-ins').value,
            logo_url: document.getElementById('cfg-logo').value,
            title: document.getElementById('cfg-title').value
        };
        update(ref(db, 'key-login-dumodz/app_config'), payload)
        .then(() => Swal.fire('Success', 'App config updated successfully!', 'success'));
    };

    window.openAddModal = () => {
        document.getElementById('edit-id').value = "-1";
        document.getElementById('modalTitle').innerText = "Create New Key";
        document.getElementById('key-name').value = "";
        document.getElementById('key-expiry').value = "";
        document.getElementById('key-status').value = "active";
        document.getElementById('key-device').value = "ANY";
        keyModal.show();
    };

    window.openEditModal = (i) => {
        const item = masterData.auth_database[i];
        document.getElementById('edit-id').value = i;
        document.getElementById('modalTitle').innerText = "Modify License";
        document.getElementById('key-name').value = item.key;
        document.getElementById('key-expiry').value = item.expiry;
        document.getElementById('key-status').value = item.status;
        document.getElementById('key-device').value = item.device_id;
        keyModal.show();
    };

    window.saveKeyData = () => {
        const idx = parseInt(document.getElementById('edit-id').value);
        const obj = {
            device_id: document.getElementById('key-device').value || "ANY",
            expiry: document.getElementById('key-expiry').value || "Unlimited",
            key: document.getElementById('key-name').value,
            status: document.getElementById('key-status').value
        };

        if(!obj.key) return Swal.fire('Error', 'Key name is required', 'error');

        let dbList = masterData.auth_database || [];
        if(idx === -1) dbList.unshift(obj); else dbList[idx] = obj;
        
        set(ref(db, 'key-login-dumodz/auth_database'), dbList)
        .then(() => { keyModal.hide(); Swal.fire('Success', 'Key Database Updated!', 'success'); });
    };

    window.deleteKey = (i) => {
        Swal.fire({
            title: 'Delete Key?', text: "This action cannot be undone!", 
            icon: 'warning', showCancelButton: true, confirmButtonColor: '#ef4444'
        }).then(r => {
            if(r.isConfirmed) {
                let list = masterData.auth_database;
                list.splice(i, 1);
                set(ref(db, 'key-login-dumodz/auth_database'), list);
            }
        });
    };

    window.generateKey = () => {
        document.getElementById('key-name').value = "DUMODZ-" + Math.random().toString(36).substring(2, 10).toUpperCase();
    };

    window.copyKey = (t) => {
        navigator.clipboard.writeText(t);
        Swal.fire({ title: 'Copied!', timer: 1000, showConfirmButton: false, toast: true, position: 'top-end', icon: 'success' });
    };

    window.filterKeys = () => {
        const q = document.getElementById('search-input').value.toLowerCase();
        document.querySelectorAll('.search-item').forEach(el => {
            el.style.display = el.dataset.search.includes(q) ? 'block' : 'none';
        });
    };

    window.toggleSidebar = () => {
        document.getElementById('sidebar').classList.toggle('active');
        document.getElementById('overlay').classList.toggle('active');
    };
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
